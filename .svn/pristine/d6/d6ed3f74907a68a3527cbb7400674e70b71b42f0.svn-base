package com.orders.controllers;

import com.orders.facade.ProductFacade;
import org.orders.entity.Items;
import org.orders.entity.Product;
import org.primefaces.event.FileUploadEvent;
import org.primefaces.model.DefaultStreamedContent;
import org.primefaces.model.StreamedContent;
import org.primefaces.model.UploadedFile;

import javax.annotation.PostConstruct;
import javax.ejb.EJB;
import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.context.FacesContext;
import javax.servlet.ServletContext;
import java.io.*;
import java.util.Date;
import java.util.List;
import java.util.logging.Logger;

@ManagedBean(name="itemController")
@SessionScoped
public class ItemController {
    private static Logger log = Logger.getLogger(ItemController.class.getName());
    private List<Items> itemList;
    //private Items selected;
    private Product selected;
    private List<Product> products;

    @EJB
    private ProductFacade productFacade;


    @PostConstruct
    public void init(){
        FacesContext.getCurrentInstance().getExternalContext().getSession(true);
        products = productFacade.findAll();
        if(!productFacade.findAll().isEmpty()){
            products = productFacade.findAll();
            selected = products.get(0);
        }else{selected = new Product();}

        /*Items item1 = new Items();
        item1.setItemId("ТП00001");
        item1.setItemName("Рыба");

        Items item2 = new Items();
        item2.setItemId("ТП00002");
        item2.setItemName("Краб");

        Items item3 = new Items();
        item3.setItemId("ТП00003");
        item3.setItemName("Икра");

        selected = item1;
        itemList = new ArrayList<Items>();
        itemList.add(item1);
        itemList.add(item2);
        itemList.add(item3);*/
    }
    public void handleFileUpload(FileUploadEvent event) throws IOException {
        UploadedFile file = event.getFile();

        ServletContext servletContext = (ServletContext) FacesContext.getCurrentInstance().getExternalContext().getContext();
        String newFileName = servletContext.getRealPath("") + File.separator + "resources\\content" + File.separator+ file.getFileName();
        String path = servletContext.getRealPath("") + File.separator + "resources\\content\\";

        String name = /*selected.getItemId() +*/
                 event.getFile().getFileName().substring(
                event.getFile().getFileName().lastIndexOf('.'));
        InputStream is = file.getInputstream();
        File outfile = new File(path + name);
        OutputStream out = new FileOutputStream(outfile);
        byte buf[] = new byte[1024];
        int len;
        while ((len = is.read(buf)) > 0)
            //fos.write(buf, 0, len);
            out.write(buf, 0, len);
        is.close();
        out.close();
        //fos.close();
        addMessage("upload.successful" + file.getFileName() + " is uploaded.");
    }

    public void handleFileUploadDB(FileUploadEvent event) throws IOException {
        UploadedFile file = event.getFile();
        log.info("Item file uploaded" + file.getSize());
        selected.setPhoto(file.getContents());
        productFacade.edit(selected);
        addMessage("upload.successful" + file.getFileName() + " is uploaded.");
    }

    public StreamedContent getImage() throws IOException {
        if(selected.getPhoto() != null){
            return new DefaultStreamedContent(new ByteArrayInputStream(selected.getPhoto()));
        }
        return null;
    }
    public void create(){

        Product product = new Product();
        product.setName("Good");
        product.setProduct("dfsgdfg");
        product.setCreatedBy("Admin");
        product.setCreatedAt(new Date());
        product.setUpdatedBy("Admin");
        product.setUpdatedAt(new Date());
        product.setVersion(Long.valueOf(1));

        selected = product;
        productFacade.create(product);
        products = productFacade.findAll();
        addMessage("Товар создан!");
    }
    public void edit(){
        productFacade.edit(selected);
        selected = productFacade.find(selected.getRecid());
        products.clear();
        products = productFacade.findAll();
        addMessage("Товар обновлен!");
    }
    public void delete(){
        try{
            productFacade.remove(selected);
            log.info("Удален объект");
        }
        catch (Exception ex){addMessage(ex.getCause().getMessage());}
        products = productFacade.findAll();
        selected = products.get(0);
        addMessage("Товар удален!");
    }
    public void search(){

        addMessage("Товар найден!");
    }

    public List<Items> getItemList() {
        return itemList;
    }

    public void setItemList(List<Items> itemList) {
        this.itemList = itemList;
    }

    public Product getSelected() {
        return selected;
    }

    public void setSelected(Product selected) {
        this.selected = selected;
    }

    public List<Product> getProducts() {
        return products;
    }

    public void setProducts(List<Product> products) {
        this.products = products;
    }

    public void addMessage(String summary) {
        FacesMessage message = new FacesMessage(FacesMessage.SEVERITY_INFO, summary,  null);
        FacesContext.getCurrentInstance().addMessage(null, message);
    }
}
